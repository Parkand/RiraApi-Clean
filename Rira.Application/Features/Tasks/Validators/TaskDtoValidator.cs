using FluentValidation;
using Rira.Application.DTOs;
using Rira.Domain.Enums;
using System.Text.RegularExpressions;
using TaskStatus = Rira.Domain.Enums.TaskStatus;

namespace Rira.Application.Features.Tasks.Validators
{
    // 🧭 کلاس اعتبارسنجی TaskDto با FluentValidation
    // ===============================================================================
    // این کلاس مسئول بررسی صحت و سازگاری داده‌های ورودی مربوط به تسک‌ها (TaskDto) است.
    // تمام قوانین اعتبارسنجی قبل از ذخیره یا بروزرسانی تسک‌ها در سرویس‌ها اعمال می‌شوند.
    //
    // 🎯 اهداف طراحی:
    //     ▫ تضمین اعتبار فیلدهای رشته‌ای (Title, Description)
    //     ▫ کنترل Enumها به‌صورت امن و محدود به مقادیر تعریف‌شده در Domain.Enums
    //     ▫ اطمینان از صحت قالب تاریخ شمسی مطابق استاندارد "yyyy/MM/dd"
    //
    // ⚙️ وابستگی‌ها:
    //     🟩 FluentValidation → برای تعریف Ruleها به‌صورت Fluent و خوانا.
    //     🟦 Regex → برای اعتبارسنجی قالب تاریخ شمسی.
    //
    // 🔹 نکته RiRaDocs:
    //     این Validator در مرحله Application اجرا می‌شود و مستقل از UI یا Handler است.
    //     خروجی خطاها در قالب RiraValidationException تجمیع می‌گردند تا تجربه‌ی کاربر سازگار باشد.
    /// <summary>
    /// معتبرسازی داده‌های ورودی برای فرمان ایجاد وظیفه.
    /// بررسی نام، تاریخ سررسید و وضعیت انجام.
    /// </summary>

    public class TaskDtoValidator : AbstractValidator<TaskDto>
    {
        // ============================================================
        // ⚙️ سازنده‌ی کلاس — تعریف تمام Ruleهای اعتبارسنجی
        // ============================================================
        public TaskDtoValidator()
        {
            // --------------------------------------------------------
            // 🔹 عنوان الزامی و حداقل ۲ کاراکتر
            // --------------------------------------------------------
            RuleFor(x => x.Title)
                .NotEmpty().WithMessage("عنوان تسک الزامی است.")
                .MinimumLength(2).WithMessage("عنوان باید حداقل ۲ کاراکتر داشته باشد.");

            // --------------------------------------------------------
            // 🔹 توضیحات اختیاری با حداکثر ۵۰۰ کاراکتر
            // --------------------------------------------------------
            RuleFor(x => x.Description)
                .MaximumLength(500).WithMessage("حداکثر طول توضیحات ۵۰۰ کاراکتر است.");

            // --------------------------------------------------------
            // 🔹 وضعیت (Status) باید یکی از مقادیر معتبر Enum باشد
            // --------------------------------------------------------
            // در اینجا از متد کمکی BeAValidStatus برای بررسی صحت مقدار استفاده می‌شود.
            RuleFor(x => x.Status)
                .Must(BeAValidStatus)
                .WithMessage("مقدار وضعیت نامعتبر است.");

            // --------------------------------------------------------
            // 🔹 اولویت (Priority) باید یکی از مقادیر معتبر Enum باشد
            // --------------------------------------------------------
            RuleFor(x => x.Priority)
                .Must(BeAValidPriority)
                .WithMessage("مقدار اولویت نامعتبر است.");

            // --------------------------------------------------------
            // 🔹 تاریخ‌های CreatedAt و UpdatedAt باید به فرمت شمسی باشند
            // --------------------------------------------------------
            // در RiRa تمام تاریخ‌ها به‌صورت string با فرمت "yyyy/MM/dd" ذخیره می‌شوند.
            RuleFor(x => x.CreatedAt)
                .Must(BeAPersianDateOrNull)
                .WithMessage("تاریخ ایجاد باید به فرمت شمسی معتبر باشد.");

            RuleFor(x => x.UpdatedAt)
                .Must(BeAPersianDateOrNull)
                .WithMessage("تاریخ بروزرسانی باید به فرمت شمسی معتبر باشد.");
        }

        // ============================================================
        // 🔸 متدهای کمکی — Validation Helpers
        // ============================================================

        // 🟩 بررسی معتبر بودن مقدار Enum وضعیت
        // ------------------------------------------------------------
        // با استفاده از Enum.IsDefined بررسی می‌شود که مقدار ورودی در Enum تعریف شده باشد
        // تا از تزریق مقادیر غیرمجاز یا عددی خارج از دامنه جلوگیری شود.
        private bool BeAValidStatus(TaskStatus status)
        {
            return Enum.IsDefined(typeof(TaskStatus), status);
        }

        // 🟦 بررسی معتبر بودن مقدار Enum اولویت
        // ------------------------------------------------------------
        // مشابه متد بالا، ولی برای Enum TaskPriority.
        private bool BeAValidPriority(TaskPriority priority)
        {
            return Enum.IsDefined(typeof(TaskPriority), priority);
        }

        // 🟨 بررسی معتبر بودن فرمت تاریخ شمسی یا نال بودن رشته
        // ------------------------------------------------------------
        // اگر مقدار نال یا خالی باشد مجاز است؛ در غیر این صورت از Regex برای بررسی تطابق با الگوی "yyyy/MM/dd" استفاده می‌شود.
        private bool BeAPersianDateOrNull(string? date)
        {
            if (string.IsNullOrWhiteSpace(date)) return true;
            return Regex.IsMatch(date, @"^\d{4}/\d{2}/\d{2}$");
        }
    }

    // ===========================================================================================
    // 📘 خلاصه آموزشی (RiraDocs Teaching Edition)
    // -------------------------------------------------------------------------------------------
    // 🔹 مفهوم:
    //     TaskDtoValidator پایه‌ی سیستم اعتبارسنجی مدل TaskDto است،
    //     که قبل از اعمال تغییرات در پایگاه داده یا ارسال پاسخ Handler اجرا می‌شود.
    //
    // 🔹 جریان اعتبارسنجی RiRa:
    //     ▫ Handler → Service → Validator → ResponseModel<T>
    //     ▫ در صورت وجود خطا، استثنا از نوع RiraValidationException تولید می‌گردد.
    //
    // 🔹 نکات معماری:
    //     ▫ جداسازی قوانین اعتبارسنجی از منطق سرویس برای افزایش قابلیت نگهداری.
    //     ▫ استفاده از FluentValidation → خوانایی بالا و قابل‌توسعه بودن قوانین.
    //     ▫ الگوی تاریخ شمسی یکسان برای تمام Domain Entities.
    //
    // 🔹 اصول طراحی آموزش‌محور:
    //     ▫ SRP — هر Validator فقط یک مدل خاص را اعتبارسنجی می‌کند.
    //     ▫ Extensible Rules — قوانین به سادگی قابل افزودن‌اند.
    //     ▫ Localizable Messages — پیام‌ها کاملاً فارسی و کاربرپسند هستند.
    //
    // 🔹 تگ انتشار RiRaDocs:
    //     RiraDocs-v2025.11.4-Stable-Final-Fixed
    // ===========================================================================================
}
