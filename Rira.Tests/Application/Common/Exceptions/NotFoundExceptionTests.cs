using Xunit;
using FluentAssertions;
using Rira.Application.Common.Exceptions;

namespace Rira.Tests.Application.Common.Exceptions
{
    // 🧪 کلاس تست واحد RiRaDocs برای Exception نوع NotFoundException
    // ===============================================================================
    // این کلاس تست واحد، رفتار کامل استثناء "NotFoundException" را بررسی می‌کند.
    // این Exception در مواقعی استفاده می‌شود که داده‌ای با شناسه مشخص در دیتابیس
    // یافت نشود؛ مثلاً در سرویس TaskService زمانی که رکورد مرتبط با Id ورودی وجود ندارد.
    //
    // 🎯 اهداف آموزشی RiRaDocs:
    //     ▫ بررسی سازنده‌های مختلف: با (EntityName + Key) و با پیام ساده.
    //     ▫ اعتبارسنجی پراپرتی‌های داخلی (EntityName, Key).
    //     ▫ حصول اطمینان از تولید پیام فارسی خوانا و استاندارد.
    //     ▫ پشتیبانی از انواع مختلف داده برای Key (int, string و غیره).
    // ===============================================================================
    public class NotFoundExceptionTests
    {
        // -------------------------------------------------------------------------------
        // 🔹 تست ۱: سازنده اصلی با EntityName و Key
        // -------------------------------------------------------------------------------
        // هدف: بررسی پیام تولیدی، مقداردهی صحیح پراپرتی‌ها و رعایت فرمت فارسی.
        // -------------------------------------------------------------------------------
        [Fact]
        public void Constructor_Should_Create_Correct_Message_And_Set_Properties()
        {
            string entity = "Task";
            int id = 42;

            var exception = new NotFoundException(entity, id);

            exception.EntityName.Should().Be(entity, "نام موجودیت باید همان مقداری باشد که ارسال کردیم.");
            exception.Key.Should().Be(id, "شناسه باید دقیقاً برابر داده ورودی باشد.");
            exception.Message.Should().Contain(entity, "پیام خطا باید نام موجودیت را شامل شود.");
            exception.Message.Should().Contain(id.ToString(), "پیام باید شناسه را نیز ذکر کند.");
            exception.Message.Should().StartWith("موجودیت", "الگوی پیام باید فارسی استاندارد باشد.");
        }

        // -------------------------------------------------------------------------------
        // 🔹 تست ۲: سازنده با نوع داده متفاوت برای Key (string)
        // -------------------------------------------------------------------------------
        // هدف: تأیید پشتیبانی از کلیدهای غیرعددی (مثل کد کاربر یا کد سفارش).
        // -------------------------------------------------------------------------------
        [Fact]
        public void Constructor_Should_Work_With_String_Key()
        {
            var exception = new NotFoundException("User", "USR-123");

            exception.EntityName.Should().Be("User");
            exception.Key.Should().Be("USR-123");
            exception.Message.Should().Contain("USR-123", "باید مقدار کلید متنی در پیام وجود داشته باشد.");
        }

        // -------------------------------------------------------------------------------
        // 🔹 تست ۳: سازنده ساده فقط با پیام
        // -------------------------------------------------------------------------------
        // هدف: بررسی حالت کدنویسی زمانی که فقط متن پیام نیاز است و EntityName یا Key وجود ندارد.
        // -------------------------------------------------------------------------------
        [Fact]
        public void Constructor_Should_Accept_Simple_Message()
        {
            string customMessage = "رکورد مورد نظر یافت نشد.";

            var exception = new NotFoundException(customMessage);

            exception.Message.Should().Be(customMessage, "در حالت ساده، پیام نباید تغییر کند.");
            exception.EntityName.Should().BeNull("در سازنده ساده نباید مقداردهی شود.");
            exception.Key.Should().BeNull("در سازنده ساده نباید مقداردهی شود.");
        }

        // -------------------------------------------------------------------------------
        // 🔹 تست ۴: اطمینان از غیرخالی بودن Message در هر سازنده
        // -------------------------------------------------------------------------------
        // هدف: تضمین عدم ایجاد پیام Null یا خالی در ساختار Exception.
        // -------------------------------------------------------------------------------
        [Fact]
        public void Exception_Should_Always_Have_NonEmpty_Message()
        {
            var exception1 = new NotFoundException("Task", 10);
            var exception2 = new NotFoundException("خطای نمونه");

            exception1.Message.Should().NotBeNullOrEmpty("نباید پیام خالی داشته باشد.");
            exception2.Message.Should().NotBeNullOrEmpty("نباید پیام خالی داشته باشد.");
        }

        // -------------------------------------------------------------------------------
        // 🔹 تست ۵: بررسی فرمت استاندارد پیام خروجی فارسی
        // -------------------------------------------------------------------------------
        // قالب مورد انتظار RiRaDocs:
        //     «موجودیت 'EntityName' با شناسهٔ 'Key' یافت نشد.»
        // هدف: تضمین تولید دقیق پیام طبق الگوی فوق.
        // -------------------------------------------------------------------------------
        [Fact]
        public void Message_Should_Have_Expected_Format_For_MainConstructor()
        {
            var exception = new NotFoundException("Task", 999);

            string expected = "موجودیت 'Task' با شناسهٔ '999' یافت نشد.";

            exception.Message.Should().Be(expected, "پیام باید دقیقاً مطابق فرمت مورد انتظار فارسی باشد.");
        }

        // -------------------------------------------------------------------------------
        // 🔹 تست ۶: بررسی حالت‌های Null در سازنده ساده
        // -------------------------------------------------------------------------------
        // هدف: اطمینان از اینکه پراپرتی‌های EntityName و Key فقط زمانی مقداردهی می‌شوند
        // که از سازنده دوپارامتری استفاده شده باشد.
        // -------------------------------------------------------------------------------
        [Fact]
        public void EntityName_And_Key_Should_Be_Null_If_Using_Simple_Message()
        {
            var exception = new NotFoundException("داده یافت نشد");

            exception.EntityName.Should().BeNull("در سازنده ساده نباید مقداردهی شود.");
            exception.Key.Should().BeNull("در سازنده ساده نباید مقداردهی شود.");
        }
    }

    // ===============================================================================
    // 📘 خلاصه آموزشی RiRaDocs Teaching Edition
    // ------------------------------------------------------------------------------
    // 🔹 سطح پوشش تست:
    //     ▫ تمام سازنده‌های کلاس NotFoundException بررسی شده‌اند.
    //     ▫ رفتار خروجی Message و مقداردهی فیلدهای داخلی آزموده شده است.
    //
    // 🔹 فناوری‌ها:
    //     ▫ xUnit → فریم‌ورک استاندارد تست واحد پروژه.
    //     ▫ FluentAssertions → نگارش خوانا و طبیعی برای Assertions.
    //
    // 🔹 اصول تست رعایت‌شده:
    //     ▫ تست مستقل از وابستگی‌های خارجی (Pure Unit Test).
    //     ▫ بررسی همه سناریوهای ممکن (int, string, null).
    //     ▫ تطبیق کامل با فرمت پیام فارسی استاندارد معماری ریرا.
    //
    // 🔹 تگ انتشار RiRaDocs:
    //     RiraDocs-v2025.11.4-Stable-Final-Fixed
    // ===============================================================================
}
